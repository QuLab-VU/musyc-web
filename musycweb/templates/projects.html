{% extends "base.html" %}

{% block title %}
<br>
<div class="row">
    <div class="col-sm-8">
        <h3>My Projects</h3>
    </div>
    <div class="col-sm-4">
        <button class="btn btn-primary btn-block" href="#" data-toggle="modal" data-target="#projectModal">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="17" fill="currentColor" class="bi bi-plus-lg" viewBox="0 0 16 16">
                <path d="M8 0a1 1 0 0 1 1 1v6h6a1 1 0 1 1 0 2H9v6a1 1 0 1 1-2 0V9H1a1 1 0 0 1 0-2h6V1a1 1 0 0 1 1-1z"/>
            </svg> Create Project</button>
    </div>
{% endblock %}

{% block content %}
<br>
<div class="">
    {% for p in ps %}
    <div class="">
        <div class="card-box shadow-sm" style="padding: 1.1rem; margin-bottom: 10px">
            <div class="dropdown arrow-none float-right">
                <a href=# class="dropdown arrow-none card-drop" data-toggle="dropdown" aria-expanded="false">
                    <svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-three-dots-vertical" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" d="M9.5 13a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
                    </svg>
                </a>
                <div class="dropdown-menu dropdown-menu-right" style="position: absolute; transform: 
                translate3d(-140px, 9px, 0px); top: 0px; left: 0px; will-change: transform;" x-placement="bottom-end">
                    <a id="btn-share-project{{p.id}}" href=# class="dropdown-item" data-toggle="modal" data-target="#shareModal{{p.id}}">Share</a>
                    <a id="btn-edit-project{{p.id}}" href=# class="dropdown-item" data-toggle="modal" data-target="#editModal{{p.id}}">Edit</a>
                    <a id="btn-delete-project{{p.id}}" href="#" class="dropdown-item" data-toggle="modal" data-target="#deleteModal-{{p.id}}">Delete</a>
                </div>
            </div>
            <h5 class="mt-0"><a href="{% url 'index' p.id %}" class="text-dark">{{ p.name }}</a></h5>
            <p class="text-muted font-13" style="margin-bottom: 0.5rem"> {{ p.description }}</p>
            <div class="parent">
                <h6 class="child mt-0" style="display: inline-block">Datasets:</h6>
                <p id="numDatasetDiv" class=" child text-muted font-13" style="display: inline-block; margin-bottom: 0.5rem">{{ p.num_datasets }}</p>
            </div>
            <div class="parent">
                <h6 class="child mt-0" style="display: inline-block">Date Created:</h6>
                <p class=" child text-muted font-13" style="display: inline-block; margin-bottom: 0.5rem"> {{ p.creation_date }}</p>
            </div>
        </div>
    </div>
    <div id="shareModal{{p.id}}" class="modal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Share This Project</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                </div>
                <div class="modal-body">
                    <form class="form-vertical" id="share-project-form" action="{% url 'share_project'%}" method="post" > 
                        {% csrf_token %}
                        <div id="div_id_name" class="form-group">
                            <label for="project_id">Project: {{ p.name }}</label>
                            <div class="">
                                <input type="hidden" name="project_id" style="display:none;" class="form-control-plaintext" value="{{p.id}}" required id="id_pid">
                            </div>
                            <label for="email" class="requiredField">
                                User email<span class="asteriskField">*</span> 
                            </label> 
                            <div class=""> 
                                <input type="email" name="email" class="form-control" required id="id_email" placeholder="email@example.com"> 
                            </div> 
                        </div>
                        <div class="form-group"> 
                            <div class=""> 
                                <input type="submit" name="submit" value="Share Project" class="btn btn-primary btn-block" id="submit-id-submit"/> 
                            </div> 
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="editModal{{p.id}}" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Edit Project Details</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
                <form class="form-vertical" id="edit-project-form" action="/projects/edit_project/" method="post"> 
                    {% csrf_token %}
                    <div id="div_id_name" class="form-group">
                        <div class="">
                            <input type="hidden" name="project_id" style="display:none;" class="form-control-plaintext" value="{{p.id}}" required id="id_pid">
                        </div>
                        <label for="name">Name</label> 
                        <div class=""> 
                            <input type="text" name="name" value="{{p.name}}" class="textinput textInput form-control form-control" aria-describedby="nameHelpBlock" id="id_name"> 
                        </div>
                        <small id="nameHelpBlock" class="form-text text-muted">
                            Optional
                        </small> 
                    </div>
                    <div id="div_id_description" class="form-group"> 
                        <label for="description">Description</label> 
                        <div class=""> 
                            <textarea type="text" name="description" maxlength="100" class="textinput form-control" aria-describedby="descrHelpBlock" id="id_description" 
                            style="margin-top: 0px; margin-bottom: 0px; height: 146px;">{{p.description}}</textarea> 
                        </div>
                        <small id="descrHelpBlock" class="form-text text-muted">
                            Optional
                        </small>
                    </div> 
                    <div class="form-group"> 
                        <div class=""> 
                            <input type="submit" name="submit" value="Update" class="btn btn-primary btn-block" id="submit-id-submit"/> 
                        </div> 
                    </div>
                </form>
            </div>
          </div>
        </div>
    </div>
    
    <div class="modal" id="deleteModal-{{p.id}}" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                <p>Are you sure you want to delete this project?</p>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-danger delBtn" id="btn-confirm-delete" value="{{p.id}}">Delete Project</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
              </div>
            </div>
          </div>
    </div>
    
    {% empty %}
        <div class="alert alert-info col-md-12 text-center">You have no projects. See the <a href="{% url 'help' %}">Help page</a> to get started.</div>
    {% endfor %}
</div>
<br>

<hr>
<h3>Shared Projects</h3>
<br>
<div class="">
    {% for sp in shared_ps %}
    <div class="">
        <div class="card-box shadow-sm" style="padding: 1.1rem; margin-bottom: 10px">
            <h5 class="mt-0"><a href="{% url 'index' sp.id %}" class="text-dark">{{ sp.name }}</a></h5>
            <p class="text-muted font-13" style="margin-bottom: 0.5rem"> {{ sp.description }}</p>
            <div class="parent">
                <h6 class="child mt-0" style="display: inline-block">Owner:</h6>
                <p id="ownerDiv" class=" child font-13" style="display: inline-block; margin-bottom: 0.5rem">{{ sp.owner }}</p>
            </div>
            <!--<div class="parent">
                <h6 class="child mt-0" style="display: inline-block">Shared with:</h6>
                <p id="ownerDiv" class=" child font-13" style="display: inline-block; margin-bottom: 0.5rem">{{ sp.shared_with.email }}</p> 
            </div>-->
            <div class="parent">
                <h6 class="child mt-0" style="display: inline-block">Datasets:</h6>
                <p id="numDatasetDiv" class=" child text-muted font-13" style="display: inline-block; margin-bottom: 0.5rem">{{ sp.num_datasets }}</p>
            </div>
            <div class="parent">
                <h6 class="child mt-0" style="display: inline-block">Date Created:</h6>
                <p id="dateCreateDiv" class=" child text-muted font-13" style="display: inline-block; margin-bottom: 0.5rem"> {{ sp.creation_date }}</p>
            </div>
        </div>
    </div>
    {% empty %}
        <div class="alert alert-info col-md-12 text-center">You have no shared projects. See the <a href="{% url 'help' %}">Help page</a> to get started.</div>
    {% endfor %}
</div>

<div id="projectModal" class="modal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title">Create New Project</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
        </div>
        <div class="modal-body">
            <form class="form-vertical" id="create-project-form" action="/projects/create_project/" method="post" > 
                {% csrf_token %}
                <div id="div_id_name" class="form-group"> 
                    <label for="name" class="requiredField">
                            Name<span class="asteriskField">*</span> 
                    </label> 
                    <div class=""> 
                        <input type="text" name="name" class="textinput textInput form-control form-control" required id="id_name"> 
                    </div> 
                </div>
                <div id="div_id_description" class="form-group"> 
                    <label for="description" class="requiredField">
                        Description<span class="asteriskField">*</span> 
                    </label> 
                    <div class=""> 
                        <textarea type="text" name="description" maxlength="100" class="textinput form-control" required id="id_description" 
                        style="margin-top: 0px; margin-bottom: 0px; height: 146px;"></textarea> 
                    </div> 
                </div> 
                <div class="form-group"> 
                    <div class=""> 
                        <input type="submit" name="submit" value="Create Project" class="btn btn-primary btn-block" id="submit-id-submit"/> 
                    </div> 
                </div>
            </form>
        </div>
    </div>
  </div>
</div>

<div class="modal" id="loading-modal" tabindex="-1" role="dialog" data-keyboard="false" data-backdrop="static">
    <div class="modal-dialog modal-dialog-centered justify-content-center" role="document">
        <div style="background-color: rgba(0, 0, 0, 0.7); color:#fff;padding: 20px;margin:auto" class="text-center">
            <h1>Processing</h1>
            <p>Please do not navigate away from this page</p>
            <div class="spinner-border" role="status">
              <span class="sr-only">Loading...</span>
            </div>
        </div>
    </div>
</div>


{% endblock %}

{% block tailscript %}
<script>
var getCookie = function (name) {
     var cookieValue = null;
     if (document.cookie && document.cookie !== "") {
         var cookies = document.cookie.split(";");
         for(var i = 0, cookieLen = cookies.length; i < cookieLen; i++) {
             var cookie = jQuery.trim(cookies[i]);
             if (cookie.substring(0, name.length + 1) === (name + "=")) {
                 cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
             break;
             }
         }
    }
    return cookieValue;
};

/*
var $shareProjForm = $('#share-project-form');
$shareProjForm.submit(function(e) {
    $.ajax({
            type: frm.attr('method'),
            url: frm.attr('action'),
            data: frm.serialize(),
            success: function () {
                window.location = "{% url 'projects' %}";
            },
            error: function() {
                $('#loading-modal').modal('hide');
            alert('An error occurred. This project may not exist or you may not have permission to edit it.');
            }
        });
        return false;
});

var $editProjForm = $('#edit-project-form');
$editProjForm.on('submit', function(e) {
    $.ajax({
            type: frm.attr('method'),
            url: frm.attr('action'),
            success: function () {
                window.location = "{% url 'projects' %}";
            },
            error: function() {
                $('#loading-modal').modal('hide');
            alert('An error occurred. This project may not exist or you may not have permission to edit it.');
            }
        });
        return false;
});
*/

//$('#btn-confirm-delete').click(function(e) {
$('.delBtn').click(function(e) {
    var pid = $(this).attr('value');
    $('#deleteModal' + pid).modal('hide');
    $('#loading-modal').modal();
    $.ajax({
        type: 'DELETE',
        url: "projects/delete_project/" + pid,
        headers: { 'X-CSRFToken': getCookie('csrftoken') },
        success: function() {
            window.location = "{% url 'projects' %}";
        },
        error: function() {
            $('#loading-modal').modal('hide');
            alert('An error occurred. This project may not exist or you may not have permission to delete it.');
        },
        dataType: 'json'});
});

</script>
{% endblock %}