{% extends "base.html" %}

{% block title %}Dataset: {{ d.name }}{% endblock %}
{% block content %}
    Uploaded: {{ d.creation_date }}

    <br><br>

    <div id="results-table-spinner" class="spinner-border" role="status" style="margin:auto">
      <span class="sr-only">Loading...</span>
    </div>
    <table class="table" id="results-table" style="display:none">
    <thead>
    <tr>
        <th>Drug 1</th>
        <th>Drug 2</th>
        <th>Sample</th>
        <th>Status</th>
    </tr>
    </thead>
    {% for task in tasks %}
        <tr>
            <td>{{ task.drug1 }}</td>
            <td>{{ task.drug2 }}</td>
            <td>{{ task.sample }}</td>
            <td><div id="task-{{ task.task_uuid }}-status">{% if task.status == 'SUCCESS' %}
                <a href="{% url 'view_task' task.task_uuid %}">{{ task.status }}</a>
            {% else %}{{ task.status }}{% endif %}</div></td>
        </tr>
    {% endfor %}
    </table>

    <br>

    <a class="btn btn-primary btn-block" href="{% url 'ajax_dataset_csv' d.id %}">Download parameters</a>

    <a class="btn btn-secondary btn-block" href="{% url 'index' %}">Back to home page</a>

    <br>

{% endblock %}
{% block css %}<link rel="stylesheet" href="//cdn.datatables.net/1.10.20/css/jquery.dataTables.min.css">{% endblock %}
{% block tailscript %}
<script src="//cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js"></script>
<script>
var pollStatus = function() {
    $.ajax({
        url: '{% url 'ajax_task_status' d.id %}',
        data: null,
        success: function (data) {
            var checkAgain = false;
            for (var uuid in data) {
                if (data.hasOwnProperty(uuid)) {
                    var updateStr = '';
                    if (data[uuid] === 'SUCCESS') {
                        updateStr = '<a href="/task/' + uuid + '">SUCCESS</a>';
                    } else {
                        updateStr = data[uuid];
                        if(data[uuid] !== 'FAILURE') {
                            checkAgain = true;
                        }
                    }
                    $('#task-' + uuid + '-status').html(updateStr);
                }
            }
            if(checkAgain) {
                setTimeout(pollStatus, 2000);
            }
        },
        dataType: 'json'
    });
};
$(function() {
    $('#results-table').dataTable({
        ajax: '{% url 'ajax_tasks' d.id %}',
        columns: [
            {},
            {},
            {},
            {render:function ( data, type, row, meta ) {
                if(data === 'SUCCESS' || data === 'FAILURE')
                    return '<div id="task-'+row[4]+'-status"><a href="/task/'+row[4]+'">'+data+'</a></div>';
                else
                    return '<div id="task-'+row[4]+'-status">'+data+'</div>'
            }}
        ],
        initComplete: function(settings, json) {
            for(var i=0; i<json['data'].length; i++) {
                var status = json['data'][i][3];
                if(status !== 'SUCCESS' && status !== 'FAILURE') {
                    pollStatus();
                    break;
                }
            }
        }
    }).show();
    $('#results-table-spinner').hide();
});
</script>
{% endblock %}