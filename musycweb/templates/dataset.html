{% extends "base.html" %}

{% block title %}Dataset: {{ d.name }}{% endblock %}
{% block content %}
    <div class="progress">
        <div id="progress-inprogress" class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
        <div id="progress-success" class="progress-bar bg-success" role="progressbar" style="width: 0" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
        <div id="progress-failed" class="progress-bar bg-danger" role="progressbar" style="width: 0" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
    </div>
    <div id="progress-rightlabel" style="float:right"></div>
    <div id="progress-leftlabel"></div>


    <br>

    <table class="table" id="results-table" style="display:none">
    <thead>
    <tr>
        <th>Drug 1</th>
        <th>Drug 2</th>
        <th>Sample</th>
        <th>Status</th>
    </tr>
    </thead>
    {% for task in tasks %}
        <tr>
            <td>{{ task.drug1 }}</td>
            <td>{{ task.drug2 }}</td>
            <td>{{ task.sample }}</td>
            <td><div id="task-{{ task.task_uuid }}-status">{% if task.status == 'SUCCESS' %}
                <a href="{% url 'view_task' task.task_uuid %}">{{ task.status }}</a>
            {% else %}{{ task.status }}{% endif %}</div></td>
        </tr>
    {% endfor %}
    </table>

    <br>

    <a class="btn btn-primary btn-block" href="{% url 'ajax_dataset_csv' d.id %}">Download parameters (CSV)</a>

    <a class="btn btn-secondary btn-block" href="{% url 'index' %}">Back to home page</a>

    <br>

{% endblock %}
{% block css %}<link rel="stylesheet" href="//cdn.datatables.net/1.10.20/css/jquery.dataTables.min.css">{% endblock %}
{% block tailscript %}
<script src="//cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js"></script>
<script>
var pollStatus = function() {
    $.ajax({
        url: '{% url 'ajax_task_status' d.id %}',
        data: null,
        success: function (data) {
            var checkAgain = false, numQueued = 0, numStarted = 0, numFailed = 0, numComplete = 0;
            for (var uuid in data) {
                if (data.hasOwnProperty(uuid)) {
                    var updateStr = '';
                    if (data[uuid] === 'SUCCESS') {
                        numComplete++;
                        updateStr = '<a href="/task/' + uuid + '">SUCCESS</a>';
                    } else {
                        updateStr = data[uuid];
                        if (data[uuid] === 'FAILURE') {
                            numFailed++;
                        } else if (data[uuid] === 'QUEUED') {
                            numQueued++;
                            checkAgain = true;
                        } else {
                            numStarted++;
                            checkAgain = true;
                        }
                    }
                    $('#task-' + uuid + '-status').html(updateStr);
                }
            }
            setProgress(numQueued, numStarted, numFailed, numComplete);
            if(checkAgain) {
                setTimeout(pollStatus, 4000);
            }
        },
        dataType: 'json'
    });
};
var setProgress = function(numQueued, numStarted, numFailed, numComplete) {
    if(numQueued > 0 || numStarted > 0) {
        var numTerminal = numFailed + numComplete;
        var numTotal = numQueued + numStarted + numTerminal;
        var progress = Math.round(numTerminal / numTotal * 100);
        // In progress
        $('#progress-inprogress').css('width', +progress+'%').attr('aria-valuenow', progress);
        if(numTerminal === 0) {
            $('#progress-leftlabel').text('Waiting in queue...')
        } else {
            $('#progress-leftlabel').text(numTerminal + ' of ' + numTotal + ' fits complete');
        }
    } else {
        // Complete
        var failedPc = numFailed / (numFailed + numComplete) * 100;
        $('#progress-inprogress').css('width', '0').attr('aria-valuenow', 0);
        $('#progress-failed').css('width', failedPc + '%').attr('aria-valuenow', failedPc);
        $('#progress-success').css('width', 100-failedPc + '%').attr('aria-valuenow', 100-failedPc);
        if(numFailed > 0) {
            $('#progress-leftlabel').text(numComplete + ' fits successful');
            $('#progress-rightlabel').text(numFailed + ' fits failed');
        } else {
            $('#progress-leftlabel').text('Fitting completed successfully')
        }
    }
};
$(function() {
    $('#page-loading').show();
    $('#results-table').dataTable({
        ajax: '{% url 'ajax_tasks' d.id %}',
        columns: [
            {},
            {},
            {},
            {render:function ( data, type, row, meta ) {
                if(data === 'SUCCESS' || data === 'FAILURE')
                    return '<div id="task-'+row[4]+'-status"><a href="/task/'+row[4]+'">'+data+'</a></div>';
                else
                    return '<div id="task-'+row[4]+'-status">'+data+'</div>'
            }}
        ],
        initComplete: function(settings, json) {
            $('#page-loading').hide();
            var numQueued = 0, numStarted = 0, numFailed = 0, numComplete = 0;
            for(var i=0; i<json['data'].length; i++) {
                var status = json['data'][i][3];
                if (status === 'SUCCESS') {
                    numComplete++;
                } else if (status === 'FAILURE') {
                    numFailed++;
                } else if (status === 'QUEUED') {
                    numQueued++;
                } else {
                    numStarted++;
                }
            }
            setProgress(numQueued, numStarted, numFailed, numComplete);
            if(numQueued > 0 || numStarted > 0) {
                setTimeout(pollStatus, 2000);
            }
        }
    }).show();
});
</script>
{% endblock %}